// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  CK.Smartboard.View = (function(_super) {

    __extends(View, _super);

    function View() {
      return View.__super__.constructor.apply(this, arguments);
    }

    View.findOrCreate = function(parent, selector, html) {
      var el;
      el = parent.find(selector);
      if (el.length > 0) {
        return el;
      }
      el = jQuery(html);
      parent.append(el);
      return el;
    };

    return View;

  })(Sail.App);

  CK.Smartboard.View.ContributionBubble = (function(_super) {

    __extends(ContributionBubble, _super);

    function ContributionBubble() {
      this.findOrCreate = __bind(this.findOrCreate, this);

      this.domID = __bind(this.domID, this);

      this.renderTags = __bind(this.renderTags, this);

      this.render = __bind(this.render, this);

      this.initialize = __bind(this.initialize, this);
      return ContributionBubble.__super__.constructor.apply(this, arguments);
    }

    ContributionBubble.prototype.tagName = 'article';

    ContributionBubble.prototype.initialize = function() {
      return this.$el.data('view', this);
    };

    ContributionBubble.prototype.render = function() {
      var body, headline, meta,
        _this = this;
      this.$el.addClass('balloon contribution');
      this.$el.attr('id', this.domID());
      headline = this.findOrCreate('.headline', "<h3 class='headline'></h3>");
      headline.text(this.model.get('headline'));
      body = this.findOrCreate('.body', "<div class='body'></div>");
      body.text(this.model.get('body'));
      meta = this.findOrCreate('.meta', "<div class='meta'><span class='author'></span></div>");
      meta.find('.author').text(this.model.get('author')).addClass("author-" + (this.model.get('author')));
      this.renderTags();
      if (!(this.$el.parent().length > 0)) {
        this.$el.addClass('new');
        this.$el.draggable({
          stop: function(ev, ui) {
            _this.model.save({
              pos: ui.position
            });
            return true;
          }
        });
        jQuery('#wall').append(this.$el);
      }
      return this;
    };

    ContributionBubble.prototype.renderTags = function() {
      var md5tag, tagClass, tagSpan, tagText, tagsContainer, validTagClasses, _i, _len, _ref;
      tagsContainer = this.findOrCreate('.tags', "<div class='tags'></div>");
      validTagClasses = [];
      _ref = this.model.get('tags');
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        tagText = _ref[_i];
        md5tag = MD5.hexdigest(tagText);
        tagClass = "tag-" + md5tag;
        validTagClasses.push(tagClass);
        tagSpan = CK.Smartboard.View.findOrCreate(tagsContainer, "." + tagClass, "<span class='tag " + tagClass + "></span>");
        tagSpan.text(tagText);
      }
      tagsContainer.find('.tag').not(validTagClasses.join(",")).remove();
      return this;
    };

    ContributionBubble.prototype.domID = function() {
      return "contribution-" + this.model.id;
    };

    ContributionBubble.prototype.findOrCreate = function(selector, html) {
      return CK.Smartboard.View.findOrCreate(this.$el, selector, html);
    };

    return ContributionBubble;

  })(Backbone.View);

}).call(this);
