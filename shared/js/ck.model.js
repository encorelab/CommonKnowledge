// Generated by CoffeeScript 1.3.3
(function() {
  var __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  CK.Model = (function() {

    function Model() {}

    Model.configure = function(config) {
      if (!((config.run != null) && (app.run.name != null))) {
        throw "Cannot configure model because config does not have a run.name!";
      }
      config.drowsyURL = config.mongo.url + "/" + config.run.name;
      CK.Model.prototype.Contribution.urlRoot = config.drowsyURL + "/contributions";
      CK.Model.prototype.Contributions.url = config.drowsyURL + "/contributions";
      return this.createNecessaryCollections(['contributions']);
    };

    return Model;

  })();

  CK.Model.prototype.DrowsyModel = (function(_super) {

    __extends(DrowsyModel, _super);

    function DrowsyModel() {
      return DrowsyModel.__super__.constructor.apply(this, arguments);
    }

    DrowsyModel.prototype.idAttribute = "_id";

    DrowsyModel.prototype.parse = function(data) {
      data._id = data._id.$oid;
      return data;
    };

    DrowsyModel.prototype.initialize = function() {
      if (!this.get(this.idAttribute)) {
        this.set(this.idAttribute, model.generateMongoObjectId());
      }
      if (!this.get('timestamp')) {
        return this.set('timestamp', Date());
      }
    };

    DrowsyModel.generateMongoObjectId = function() {
      var base, rand, randLength, time;
      base = 16;
      randLength = 13;
      time = (new Date()).getTime().toString(base);
      rand = Math.ceil(Math.random() * (Math.pow(base, randLength) - 1)).toString(base);
      return time + (Array(randLength + 1).join("0") + rand).slice(-randLength);
    };

    DrowsyModel.createNecessaryDatabase = function(requiredDatabase, afterwards) {
      return jQuery.ajax(app.config.mongo.url, {
        type: 'get',
        dataType: 'json',
        success: function(existingDatabases) {
          if (__indexOf.call(existingDatabases, requiredDatabase) >= 0) {
            return afterwards();
          } else {
            return jQuery.post(app.config.mongo.url, {
              db: requiredDatabase
            }, afterwards);
          }
        },
        error: function(err) {
          console.error("Couldn't fetch list of databases because: ", JSON.parse(err.responseText));
          throw err.responseText;
        }
      });
    };

    DrowsyModel.createNecessaryCollections = function(requiredCollections) {
      return jQuery.ajax(app.drowsyURL, {
        type: 'get',
        dataType: 'json',
        success: function(existingCollections) {
          var col, _i, _len, _results;
          _results = [];
          for (_i = 0, _len = requiredCollections.length; _i < _len; _i++) {
            col = requiredCollections[_i];
            if (__indexOf.call(existingCollections, col) < 0) {
              console.log("Creating collection '" + col + "' under " + app.drowsyURL);
              _results.push(jQuery.post(app.drowsyURL, {
                collection: col
              }));
            } else {
              _results.push(void 0);
            }
          }
          return _results;
        },
        error: function(err) {
          console.error("Couldn't fetch list of collections from " + app.drowsyURL + " because: ", JSON.parse(err.responseText));
          throw err.responseText;
        }
      });
    };

    return DrowsyModel;

  })(Backbone.Model);

  CK.Model.prototype.DrowsyCollection = (function(_super) {

    __extends(DrowsyCollection, _super);

    function DrowsyCollection() {
      return DrowsyCollection.__super__.constructor.apply(this, arguments);
    }

    DrowsyCollection.prototype.model = CK.Model.prototype.DrowsyModel;

    return DrowsyCollection;

  })(Backbone.Model);

  CK.Model.prototype.Contribution = (function(_super) {

    __extends(Contribution, _super);

    function Contribution() {
      return Contribution.__super__.constructor.apply(this, arguments);
    }

    Contribution.prototype.urlRoot = void 0;

    return Contribution;

  })(CK.Model.prototype.DrowsyModel);

  CK.Model.prototype.Contribution = (function(_super) {

    __extends(Contribution, _super);

    function Contribution() {
      return Contribution.__super__.constructor.apply(this, arguments);
    }

    Contribution.prototype.model = CK.Model.prototype.Contribution;

    Contribution.prototype.url = void 0;

    return Contribution;

  })(CK.Model.prototype.DrowsyModel);

}).call(this);
